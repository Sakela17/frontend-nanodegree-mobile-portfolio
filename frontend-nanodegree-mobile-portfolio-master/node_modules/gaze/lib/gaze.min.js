var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,d){a!=Array.prototype&&a!=Object.prototype&&(a[b]=d.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(a){return $jscomp.SYMBOL_PREFIX+(a||"")+$jscomp.symbolCounter_++};
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(a){var b=0;return $jscomp.iteratorPrototype(function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.iteratorFromArray=function(a,b){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var d=0,c={next:function(){if(d<a.length){var e=d++;return{value:b(e,a[e]),done:!1}}c.next=function(){return{done:!0,value:void 0}};return c.next()}};c[Symbol.iterator]=function(){return c};return c};
$jscomp.polyfill=function(a,b,d,c){if(b){d=$jscomp.global;a=a.split(".");for(c=0;c<a.length-1;c++){var e=a[c];e in d||(d[e]={});d=d[e]}a=a[a.length-1];c=d[a];b=b(c);b!=c&&null!=b&&$jscomp.defineProperty(d,a,{configurable:!0,writable:!0,value:b})}};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6-impl","es3");
$jscomp.findInternal=function(a,b,d){a instanceof String&&(a=String(a));for(var c=a.length,e=0;e<c;e++){var f=a[e];if(b.call(d,f,e,a))return{i:e,v:f}}return{i:-1,v:void 0}};$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,d){return $jscomp.findInternal(this,a,d).v}},"es6-impl","es3");var util=require("util"),EE=require("events").EventEmitter,fs=require("fs"),path=require("path"),globule=require("globule"),helper=require("./helper"),setImmediate=require("timers").setImmediate;
"function"!==typeof setImmediate&&(setImmediate=process.nextTick);var delay=10;
function Gaze(a,b,d){EE.call(this);"function"===typeof b&&(d=b,b={});b=b||{};b.mark=!0;b.interval=b.interval||100;b.debounceDelay=b.debounceDelay||500;b.cwd=b.cwd||process.cwd();this.options=b;d=d||function(){};this._watched=Object.create(null);this._watchers=Object.create(null);this._pollers=Object.create(null);this._patterns=[];this._cached=Object.create(null);this.options.maxListeners&&(this.setMaxListeners(this.options.maxListeners),Gaze.super_.prototype.setMaxListeners(this.options.maxListeners),
delete this.options.maxListeners);a&&this.add(a,d);this._keepalive=setInterval(function(){},200);return this}util.inherits(Gaze,EE);module.exports=function(a,b,d){return new Gaze(a,b,d)};module.exports.Gaze=Gaze;
Gaze.prototype.emit=function(){var a=this,b=arguments,d=b[0],c=b[1];if("ed"!==d.slice(-2))return Gaze.super_.prototype.emit.apply(a,b),this;"added"===d&&Object.keys(this._cached).forEach(function(c){if(-1!==a._cached[c].indexOf("deleted"))return b[0]=d="renamed",[].push.call(b,c),delete a._cached[c],!1});if(-1===(this._cached[c]||[]).indexOf(d)){helper.objectPush(a._cached,c,d);clearTimeout(e);var e=setTimeout(function(){delete a._cached[c]},this.options.debounceDelay);Gaze.super_.prototype.emit.apply(a,
b);Gaze.super_.prototype.emit.apply(a,["all",d].concat([].slice.call(b,1)))}"added"===d&&helper.isDir(c)&&fs.readdirSync(c).map(function(a){return path.join(c,a)}).filter(function(b){return globule.isMatch(a._patterns,b,a.options)}).forEach(function(b){a.emit("added",b)});return this};
Gaze.prototype.close=function(a){var b=this;a=!1===a?!1:!0;Object.keys(b._watchers).forEach(function(a){b._watchers[a].close()});b._watchers=Object.create(null);Object.keys(this._watched).forEach(function(a){b._unpollDir(a)});a&&(b._watched=Object.create(null),setTimeout(function(){b.emit("end");b.removeAllListeners();clearInterval(b._keepalive)},delay+100));return b};
Gaze.prototype.add=function(a,b){"string"===typeof a&&(a=[a]);this._patterns=helper.unique.apply(null,[this._patterns,a]);a=globule.find(this._patterns,this.options);this._addToWatched(a);this.close(!1);this._initWatched(b)};Gaze.prototype._internalAdd=function(a,b){var d=[];helper.isDir(a)?d=[helper.markDir(a)].concat(globule.find(this._patterns,this.options)):globule.isMatch(this._patterns,a,this.options)&&(d=[a]);0<d.length&&(this._addToWatched(d),this.close(!1),this._initWatched(b))};
Gaze.prototype.remove=function(a){var b=this;this._watched[a]?(this._unpollDir(a),delete this._watched[a]):Object.keys(this._watched).forEach(function(d){var c=b._watched[d].indexOf(a);if(-1!==c)return b._unpollFile(a),b._watched[d].splice(c,1),!1});this._watchers[a]&&this._watchers[a].close();return this};Gaze.prototype.watched=function(){return this._watched};
Gaze.prototype.relative=function(a,b){var d=this,c=Object.create(null),e,f,g,h=this.options.cwd||process.cwd();""===a&&(a=".");a=helper.markDir(a);b=b||!1;Object.keys(this._watched).forEach(function(a){e=path.relative(h,a)+path.sep;e===path.sep&&(e=".");g=b?helper.unixifyPathSep(e):e;c[g]=d._watched[a].map(function(a){f=path.relative(path.join(h,e)||"",a||"");helper.isDir(a)&&(f=helper.markDir(f));b&&(f=helper.unixifyPathSep(f));return f})});a&&b&&(a=helper.unixifyPathSep(a));return a?c[a]||[]:c};
Gaze.prototype._addToWatched=function(a){for(var b=0;b<a.length;b++){var d=a[b],c=path.resolve(this.options.cwd,d),e=helper.isDir(d)?c:path.dirname(c),e=helper.markDir(e);!helper.isDir(d)||c in this._watched||helper.objectPush(this._watched,c,[]);"/"===d.slice(-1)&&(c+=path.sep);helper.objectPush(this._watched,path.dirname(c)+path.sep,c);d=fs.readdirSync(e);for(c=0;c<d.length;c++){var f=path.join(e,d[c]);fs.lstatSync(f).isDirectory()&&helper.objectPush(this._watched,e,f+path.sep)}}return this};
Gaze.prototype._watchDir=function(a,b){var d=this,c;try{this._watchers[a]=fs.watch(a,function(e){clearTimeout(c);c=setTimeout(function(){a in d._watchers&&fs.existsSync(a)&&b(null,a)},delay+100)})}catch(e){return this._handleError(e)}return this};Gaze.prototype._unpollFile=function(a){this._pollers[a]&&(fs.unwatchFile(a,this._pollers[a]),delete this._pollers[a]);return this};Gaze.prototype._unpollDir=function(a){this._unpollFile(a);for(var b=0;b<this._watched[a].length;b++)this._unpollFile(this._watched[a][b])};
Gaze.prototype._pollFile=function(a,b){var d={persistent:!0,interval:this.options.interval};if(!this._pollers[a]){this._pollers[a]=function(d,e){b(null,a)};try{fs.watchFile(a,d,this._pollers[a])}catch(c){return this._handleError(c)}}return this};
Gaze.prototype._initWatched=function(a){var b=this,d=this.options.cwd||process.cwd(),c=Object.keys(b._watched);1>c.length?setImmediate(function(){b.emit("ready",b);a&&a.call(b,null,b);b.emit("nomatch")}):helper.forEachSeries(c,function(a,c){a=a||"";var e=b._watched[a];b._watchDir(a,function(c,e){var f=d===a?".":path.relative(d,a),f=f||"";fs.readdir(e,function(d,c){if(d)return b.emit("error",d);if(c){try{c=c.map(function(b){return fs.existsSync(path.join(a,b))&&fs.lstatSync(path.join(a,b)).isDirectory()?
b+path.sep:b})}catch(k){}var e=b.relative(f);e.filter(function(a){return 0>c.indexOf(a)}).forEach(function(c){helper.isDir(c)||(c=path.join(a,c),b.remove(c),b.emit("deleted",c))});c.filter(function(a){return 0>e.indexOf(a)}).forEach(function(c){var d=path.join(f,c);b._internalAdd(d,function(){b.emit("added",path.join(a,c))})})}})});e.forEach(function(a){helper.isDir(a)||b._pollFile(a,function(a,c){fs.existsSync(c)&&b.emit("changed",c)})});c()},function(){setTimeout(function(){b.emit("ready",b);a&&
a.call(b,null,b)},delay+100)})};Gaze.prototype._handleError=function(a){return"EMFILE"===a.code?this.emit("error",Error("EMFILE: Too many opened files.")):this.emit("error",a)};
