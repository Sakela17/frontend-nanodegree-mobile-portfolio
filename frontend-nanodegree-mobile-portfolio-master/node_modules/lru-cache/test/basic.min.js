var test=require("tap").test,LRU=require("../");test("basic",function(b){var a=new LRU({max:10});a.set("key","value");b.equal(a.get("key"),"value");b.equal(a.get("nada"),void 0);b.equal(a.length,1);b.equal(a.max,10);b.end()});test("least recently set",function(b){var a=new LRU(2);a.set("a","A");a.set("b","B");a.set("c","C");b.equal(a.get("c"),"C");b.equal(a.get("b"),"B");b.equal(a.get("a"),void 0);b.end()});
test("lru recently gotten",function(b){var a=new LRU(2);a.set("a","A");a.set("b","B");a.get("a");a.set("c","C");b.equal(a.get("c"),"C");b.equal(a.get("b"),void 0);b.equal(a.get("a"),"A");b.end()});test("del",function(b){var a=new LRU(2);a.set("a","A");a.del("a");b.equal(a.get("a"),void 0);b.end()});
test("max",function(b){var a=new LRU(3);a.max=100;for(var c=0;100>c;c++)a.set(c,c);b.equal(a.length,100);for(c=0;100>c;c++)b.equal(a.get(c),c);a.max=3;b.equal(a.length,3);for(c=0;97>c;c++)b.equal(a.get(c),void 0);for(c=98;100>c;c++)b.equal(a.get(c),c);a.max="hello";for(c=0;100>c;c++)a.set(c,c);b.equal(a.length,100);for(c=0;100>c;c++)b.equal(a.get(c),c);a.max=3;b.equal(a.length,3);for(c=0;97>c;c++)b.equal(a.get(c),void 0);for(c=98;100>c;c++)b.equal(a.get(c),c);b.end()});
test("reset",function(b){var a=new LRU(10);a.set("a","A");a.set("b","B");a.reset();b.equal(a.length,0);b.equal(a.max,10);b.equal(a.get("a"),void 0);b.equal(a.get("b"),void 0);b.end()});test("basic with weighed length",function(b){var a=new LRU({max:100,length:function(a){return a.size}});a.set("key",{val:"value",size:50});b.equal(a.get("key").val,"value");b.equal(a.get("nada"),void 0);b.equal(a.lengthCalculator(a.get("key")),50);b.equal(a.length,50);b.equal(a.max,100);b.end()});
test("weighed length item too large",function(b){var a=new LRU({max:10,length:function(a){return a.size}});b.equal(a.max,10);a.set("key",{val:"value",size:50});b.equal(a.length,0);b.equal(a.get("key"),void 0);b.end()});
test("least recently set with weighed length",function(b){var a=new LRU({max:8,length:function(a){return a.length}});a.set("a","A");a.set("b","BB");a.set("c","CCC");a.set("d","DDDD");b.equal(a.get("d"),"DDDD");b.equal(a.get("c"),"CCC");b.equal(a.get("b"),void 0);b.equal(a.get("a"),void 0);b.end()});
test("lru recently gotten with weighed length",function(b){var a=new LRU({max:8,length:function(a){return a.length}});a.set("a","A");a.set("b","BB");a.set("c","CCC");a.get("a");a.get("b");a.set("d","DDDD");b.equal(a.get("c"),void 0);b.equal(a.get("d"),"DDDD");b.equal(a.get("b"),"BB");b.equal(a.get("a"),"A");b.end()});
test("lru recently updated with weighed length",function(b){var a=new LRU({max:8,length:function(a){return a.length}});a.set("a","A");a.set("b","BB");a.set("c","CCC");b.equal(a.length,6);a.set("a","+A");b.equal(a.length,7);a.set("b","++BB");b.equal(a.length,6);b.equal(a.get("c"),void 0);a.set("c","oversized");b.equal(a.length,6);b.equal(a.get("c"),void 0);a.set("a","oversized");b.equal(a.length,4);b.equal(a.get("a"),void 0);b.equal(a.get("b"),"++BB");b.end()});
test("set returns proper booleans",function(b){var a=new LRU({max:5,length:function(a){return a.length}});b.equal(a.set("a","A"),!0);b.equal(a.set("b","donuts"),!1);b.equal(a.set("b","B"),!0);b.equal(a.set("c","CCCC"),!0);b.end()});
test("drop the old items",function(b){var a=new LRU({max:5,maxAge:50});a.set("a","A");setTimeout(function(){a.set("b","b");b.equal(a.get("a"),"A")},25);setTimeout(function(){a.set("c","C");b.notOk(a.get("a"))},85);setTimeout(function(){b.notOk(a.get("b"));b.equal(a.get("c"),"C")},90);setTimeout(function(){b.notOk(a.get("c"));b.end()},155)});
test("individual item can have it's own maxAge",function(b){var a=new LRU({max:5,maxAge:50});a.set("a","A",20);setTimeout(function(){b.notOk(a.get("a"));b.end()},25)});test("individual item can have it's own maxAge > cache's",function(b){var a=new LRU({max:5,maxAge:20});a.set("a","A",50);setTimeout(function(){b.equal(a.get("a"),"A");b.end()},25)});
test("disposal function",function(b){var a=!1,c=new LRU({max:1,dispose:function(b,c){a=c}});c.set(1,1);c.set(2,2);b.equal(a,1);c.set(3,3);b.equal(a,2);c.reset();b.equal(a,3);b.end()});test("disposal function on too big of item",function(b){var a=!1,c=new LRU({max:1,length:function(a){return a.length},dispose:function(b,c){a=c}}),d=[1,2];b.equal(a,!1);c.set("obj",d);b.equal(a,d);b.end()});
test("has()",function(b){var a=new LRU({max:1,maxAge:10});a.set("foo","bar");b.equal(a.has("foo"),!0);a.set("blu","baz");b.equal(a.has("foo"),!1);b.equal(a.has("blu"),!0);setTimeout(function(){b.equal(a.has("blu"),!1);b.end()},15)});test("stale",function(b){var a=new LRU({maxAge:10,stale:!0});a.set("foo","bar");b.equal(a.get("foo"),"bar");b.equal(a.has("foo"),!0);setTimeout(function(){b.equal(a.has("foo"),!1);b.equal(a.get("foo"),"bar");b.equal(a.get("foo"),void 0);b.end()},15)});
test("lru update via set",function(b){var a=LRU({max:2});a.set("foo",1);a.set("bar",2);a.del("bar");a.set("baz",3);a.set("qux",4);b.equal(a.get("foo"),void 0);b.equal(a.get("bar"),void 0);b.equal(a.get("baz"),3);b.equal(a.get("qux"),4);b.end()});test("least recently set w/ peek",function(b){var a=new LRU(2);a.set("a","A");a.set("b","B");b.equal(a.peek("a"),"A");a.set("c","C");b.equal(a.get("c"),"C");b.equal(a.get("b"),"B");b.equal(a.get("a"),void 0);b.end()});
test("pop the least used item",function(b){var a=new LRU(3);a.set("a","A");a.set("b","B");a.set("c","C");b.equal(a.length,3);b.equal(a.max,3);a.get("b","B");var c=a.pop();b.equal(c.key,"a");b.equal(c.value,"A");b.equal(a.length,2);b.equal(a.max,3);c=a.pop();b.equal(c.key,"c");b.equal(c.value,"C");b.equal(a.length,1);b.equal(a.max,3);c=a.pop();b.equal(c.key,"b");b.equal(c.value,"B");b.equal(a.length,0);b.equal(a.max,3);c=a.pop();b.equal(c,null);b.equal(a.length,0);b.equal(a.max,3);b.end()});
