var test=require("tap").test,fs_=require("fs"),fs=require("../graceful-fs.js"),files=fs.readdirSync(__dirname),fds=0,nextFd=60,limit=8;fs_.open=function(c,a,b,d){process.nextTick(function(){++fds;if(fds>=limit){--fds;var a=Error("EMFILE Curses!");a.code="EMFILE";a.path=c;return d(a)}d(null,nextFd++)})};fs_.openSync=function(c,a,b){if(fds>=limit)throw a=Error("EMFILE Curses!"),a.code="EMFILE",a.path=c,a;++fds;return nextFd++};fs_.close=function(c,a){process.nextTick(function(){--fds;a()})};
fs_.closeSync=function(c){--fds};fs_.readdir=function(c,a){process.nextTick(function(){if(fds>=limit){var b=Error("EMFILE Curses!");b.code="EMFILE";b.path=c;return a(b)}++fds;process.nextTick(function(){--fds;a(null,[__filename,"some-other-file.js"])})})};fs_.readdirSync=function(c){if(fds>=limit){var a=Error("EMFILE Curses!");a.code="EMFILE";a.path=c;throw a;}return[__filename,"some-other-file.js"]};
test("open emfile autoreduce",function(c){function a(a){return function(b,f){if(b)throw b;e.push([a,f,b,fs.MAX_OPEN,fs.MIN_MAX_OPEN,fs._curOpen,fds]);11===a&&(c.same(e,d),c.ok(fs.MAX_OPEN<limit),c.end());fs.close(f)}}fs.MIN_MAX_OPEN=4;c.equal(fs.MAX_OPEN,1024);for(var b=0;12>b;b++)fs.open(__filename,"r",a(b));var d=[[0,60,null,1024,4,12,1],[1,61,null,1024,4,12,2],[2,62,null,1024,4,12,3],[3,63,null,1024,4,12,4],[4,64,null,1024,4,12,5],[5,65,null,1024,4,12,6],[6,66,null,1024,4,12,7],[7,67,null,6,4,
5,1],[8,68,null,6,4,5,2],[9,69,null,6,4,5,3],[10,70,null,6,4,5,4],[11,71,null,6,4,5,5]],e=[]});
test("readdir emfile autoreduce",function(c){function a(a){return function(b,f){if(b)throw b;e.push([a,f,b,fs.MAX_OPEN,fs.MIN_MAX_OPEN,fs._curOpen,fds]);11===a&&(c.ok(fs.MAX_OPEN<limit),c.same(e,d),c.end())}}fs.MAX_OPEN=1024;for(var b=0;12>b;b++)fs.readdir(__dirname,a(b));var d=[[0,[__filename,"some-other-file.js"],null,7,4,7,7],[1,[__filename,"some-other-file.js"],null,7,4,7,6],[2,[__filename,"some-other-file.js"],null,7,4,7,5],[3,[__filename,"some-other-file.js"],null,7,4,7,4],[4,[__filename,"some-other-file.js"],
null,7,4,7,3],[5,[__filename,"some-other-file.js"],null,7,4,6,2],[6,[__filename,"some-other-file.js"],null,7,4,5,1],[7,[__filename,"some-other-file.js"],null,7,4,4,0],[8,[__filename,"some-other-file.js"],null,7,4,3,3],[9,[__filename,"some-other-file.js"],null,7,4,2,2],[10,[__filename,"some-other-file.js"],null,7,4,1,1],[11,[__filename,"some-other-file.js"],null,7,4,0,0]],e=[]});
