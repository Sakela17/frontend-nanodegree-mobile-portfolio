var t=require("tap"),fs=require("fs"),path=require("path"),fixture=path.resolve(__dirname,"fixtures"),meow=fixture+"/meow.cat",mine=fixture+"/mine.cat",ours=fixture+"/ours.cat",fail=fixture+"/fail.false",noent=fixture+"/enoent.exe",mkdirp=require("mkdirp"),rimraf=require("rimraf"),isWindows="win32"===process.platform,hasAccess="function"===typeof fs.access,winSkip=isWindows&&"windows",accessSkip=!hasAccess&&"no fs.access function",hasPromise="function"===typeof Promise,promiseSkip=!hasPromise&&"no global Promise";
function reset(){delete require.cache[require.resolve("../")];return require("../")}t.test("setup fixtures",function(a){rimraf.sync(fixture);mkdirp.sync(fixture);fs.writeFileSync(meow,"#!/usr/bin/env cat\nmeow\n");fs.chmodSync(meow,493);fs.writeFileSync(fail,"#!/usr/bin/env false\n");fs.chmodSync(fail,420);fs.writeFileSync(mine,"#!/usr/bin/env cat\nmine\n");fs.chmodSync(mine,484);fs.writeFileSync(ours,"#!/usr/bin/env cat\nours\n");fs.chmodSync(ours,492);a.end()});
t.test("promise",{skip:promiseSkip},function(a){var b=reset();a.test("meow async",function(a){b(meow).then(function(b){a.ok(b);a.end()})});a.test("fail async",function(a){b(fail).then(function(b){a.notOk(b);a.end()})});a.test("noent async",function(a){b(noent).catch(function(b){a.ok(b);a.end()})});a.test("noent ignore async",function(a){b(noent,{ignoreErrors:!0}).then(function(b){a.notOk(b);a.end()})});a.end()});
t.test("no promise",function(a){global.Promise=null;var b=reset();a.throws("try to meow a promise",function(){b(meow)});a.end()});t.test("access",{skip:accessSkip||winSkip},function(a){runTest(a)});t.test("mode",{skip:winSkip},function(a){delete fs.access;delete fs.accessSync;var b=reset();a.ok(b.sync(ours,{uid:0,gid:0}));a.ok(b.sync(mine,{uid:0,gid:0}));runTest(a)});
t.test("windows",function(a){global.TESTING_WINDOWS=!0;a.test("pathExt option",function(a){runTest(a,{pathExt:".EXE;.CAT;.CMD;.COM"})});a.test("pathExt env",function(a){process.env.PATHEXT=".EXE;.CAT;.CMD;.COM";runTest(a)});a.test("no pathExt",function(a){runTest(a,{pathExt:"",skipFail:!0})});a.test("pathext with empty entry",function(a){runTest(a,{pathExt:";.EXE;.CAT;.CMD;.COM",skipFail:!0})});a.end()});t.test("cleanup",function(a){rimraf.sync(fixture);a.end()});
function runTest(a,b){var c=reset(),e=Object.create(b||{});e.ignoreErrors=!0;b&&b.skipFail||a.notOk(c.sync(fail,b));a.notOk(c.sync(noent,e));b?a.ok(c.sync(meow,b)):a.ok(c.sync(meow));a.ok(c.sync(mine,b));a.ok(c.sync(ours,b));a.throws(function(){c.sync(noent,b)});a.test("meow async",function(a){b?c(meow,b,function(b,d){if(b)throw b;a.ok(d);a.end()}):c(meow,function(b,d){if(b)throw b;a.ok(d);a.end()})});a.test("mine async",function(a){c(mine,b,function(b,d){if(b)throw b;a.ok(d);a.end()})});a.test("ours async",
function(a){c(ours,b,function(b,d){if(b)throw b;a.ok(d);a.end()})});b&&b.skipFail||a.test("fail async",function(a){c(fail,b,function(b,d){if(b)throw b;a.notOk(d);a.end()})});a.test("noent async",function(a){c(noent,b,function(b,c){a.ok(b);a.notOk(c);a.end()})});a.test("noent ignore async",function(a){c(noent,e,function(b,c){if(b)throw b;a.notOk(c);a.end()})});a.test("directory is not executable",function(a){c(__dirname,b,function(b,c){if(b)throw b;a.notOk(c);a.end()})});a.end()};
