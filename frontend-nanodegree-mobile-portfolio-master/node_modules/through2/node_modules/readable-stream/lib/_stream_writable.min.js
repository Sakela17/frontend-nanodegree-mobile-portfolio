var processNextTick=require("process-nextick-args");module.exports=Writable;function WriteReq(a,b,c){this.chunk=a;this.encoding=b;this.callback=c;this.next=null}function CorkedRequest(a){var b=this;this.entry=this.next=null;this.finish=function(){onCorkedFinish(b,a)}}var asyncWrite=!process.browser&&-1<["v0.10","v0.9."].indexOf(process.version.slice(0,5))?setImmediate:processNextTick,Duplex;Writable.WritableState=WritableState;var util=require("core-util-is");util.inherits=require("inherits");
var internalUtil={deprecate:require("util-deprecate")},Stream=require("./internal/streams/stream"),Buffer=require("safe-buffer").Buffer;function _uint8ArrayToBuffer(a){return Buffer.from(a)}function _isUint8Array(a){return"[object Uint8Array]"===Object.prototype.toString.call(a)||Buffer.isBuffer(a)}var destroyImpl=require("./internal/streams/destroy");util.inherits(Writable,Stream);function nop(){}
function WritableState(a,b){Duplex=Duplex||require("./_stream_duplex");a=a||{};this.objectMode=!!a.objectMode;b instanceof Duplex&&(this.objectMode=this.objectMode||!!a.writableObjectMode);var c=a.highWaterMark,d=this.objectMode?16:16384;this.highWaterMark=c||0===c?c:d;this.highWaterMark=Math.floor(this.highWaterMark);this.destroyed=this.finished=this.ended=this.ending=this.needDrain=this.finalCalled=!1;this.decodeStrings=!1!==a.decodeStrings;this.defaultEncoding=a.defaultEncoding||"utf8";this.length=
0;this.writing=!1;this.corked=0;this.sync=!0;this.bufferProcessing=!1;this.onwrite=function(a){onwrite(b,a)};this.writecb=null;this.writelen=0;this.lastBufferedRequest=this.bufferedRequest=null;this.pendingcb=0;this.errorEmitted=this.prefinished=!1;this.bufferedRequestCount=0;this.corkedRequestsFree=new CorkedRequest(this)}WritableState.prototype.getBuffer=function(){for(var a=this.bufferedRequest,b=[];a;)b.push(a),a=a.next;return b};
(function(){try{Object.defineProperty(WritableState.prototype,"buffer",{get:internalUtil.deprecate(function(){return this.getBuffer()},"_writableState.buffer is deprecated. Use _writableState.getBuffer instead.","DEP0003")})}catch(a){}})();var realHasInstance;
"function"===typeof Symbol&&Symbol.hasInstance&&"function"===typeof Function.prototype[Symbol.hasInstance]?(realHasInstance=Function.prototype[Symbol.hasInstance],Object.defineProperty(Writable,Symbol.hasInstance,{value:function(a){return realHasInstance.call(this,a)?!0:a&&a._writableState instanceof WritableState}})):realHasInstance=function(a){return a instanceof this};
function Writable(a){Duplex=Duplex||require("./_stream_duplex");if(!(realHasInstance.call(Writable,this)||this instanceof Duplex))return new Writable(a);this._writableState=new WritableState(a,this);this.writable=!0;a&&("function"===typeof a.write&&(this._write=a.write),"function"===typeof a.writev&&(this._writev=a.writev),"function"===typeof a.destroy&&(this._destroy=a.destroy),"function"===typeof a.final&&(this._final=a.final));Stream.call(this)}
Writable.prototype.pipe=function(){this.emit("error",Error("Cannot pipe, not readable"))};function writeAfterEnd(a,b){var c=Error("write after end");a.emit("error",c);processNextTick(b,c)}function validChunk(a,b,c,d){var e=!0,f=!1;null===c?f=new TypeError("May not write null values to stream"):"string"===typeof c||void 0===c||b.objectMode||(f=new TypeError("Invalid non-string/buffer chunk"));f&&(a.emit("error",f),processNextTick(d,f),e=!1);return e}
Writable.prototype.write=function(a,b,c){var d=this._writableState,e=!1,f=_isUint8Array(a)&&!d.objectMode;f&&!Buffer.isBuffer(a)&&(a=_uint8ArrayToBuffer(a));"function"===typeof b&&(c=b,b=null);f?b="buffer":b||(b=d.defaultEncoding);"function"!==typeof c&&(c=nop);if(d.ended)writeAfterEnd(this,c);else if(f||validChunk(this,d,a,c))d.pendingcb++,e=writeOrBuffer(this,d,f,a,b,c);return e};Writable.prototype.cork=function(){this._writableState.corked++};
Writable.prototype.uncork=function(){var a=this._writableState;a.corked&&(a.corked--,a.writing||a.corked||a.finished||a.bufferProcessing||!a.bufferedRequest||clearBuffer(this,a))};Writable.prototype.setDefaultEncoding=function(a){"string"===typeof a&&(a=a.toLowerCase());if(!(-1<"hex utf8 utf-8 ascii binary base64 ucs2 ucs-2 utf16le utf-16le raw".split(" ").indexOf((a+"").toLowerCase())))throw new TypeError("Unknown encoding: "+a);this._writableState.defaultEncoding=a;return this};
function decodeChunk(a,b,c){a.objectMode||!1===a.decodeStrings||"string"!==typeof b||(b=Buffer.from(b,c));return b}
function writeOrBuffer(a,b,c,d,e,f){if(!c){var g=decodeChunk(b,d,e);d!==g&&(c=!0,e="buffer",d=g)}var h=b.objectMode?1:d.length;b.length+=h;g=b.length<b.highWaterMark;g||(b.needDrain=!0);b.writing||b.corked?(a=b.lastBufferedRequest,b.lastBufferedRequest={chunk:d,encoding:e,isBuf:c,callback:f,next:null},a?a.next=b.lastBufferedRequest:b.bufferedRequest=b.lastBufferedRequest,b.bufferedRequestCount+=1):doWrite(a,b,!1,h,d,e,f);return g}
function doWrite(a,b,c,d,e,f,g){b.writelen=d;b.writecb=g;b.writing=!0;b.sync=!0;c?a._writev(e,b.onwrite):a._write(e,f,b.onwrite);b.sync=!1}function onwriteError(a,b,c,d,e){--b.pendingcb;c?(processNextTick(e,d),processNextTick(finishMaybe,a,b),a._writableState.errorEmitted=!0,a.emit("error",d)):(e(d),a._writableState.errorEmitted=!0,a.emit("error",d),finishMaybe(a,b))}function onwriteStateUpdate(a){a.writing=!1;a.writecb=null;a.length-=a.writelen;a.writelen=0}
function onwrite(a,b){var c=a._writableState,d=c.sync,e=c.writecb;onwriteStateUpdate(c);b?onwriteError(a,c,d,b,e):((b=needFinish(c))||c.corked||c.bufferProcessing||!c.bufferedRequest||clearBuffer(a,c),d?asyncWrite(afterWrite,a,c,b,e):afterWrite(a,c,b,e))}function afterWrite(a,b,c,d){c||onwriteDrain(a,b);b.pendingcb--;d();finishMaybe(a,b)}function onwriteDrain(a,b){0===b.length&&b.needDrain&&(b.needDrain=!1,a.emit("drain"))}
function clearBuffer(a,b){b.bufferProcessing=!0;var c=b.bufferedRequest;if(a._writev&&c&&c.next){var d=Array(b.bufferedRequestCount),e=b.corkedRequestsFree;e.entry=c;for(var f=0,g=!0;c;)d[f]=c,c.isBuf||(g=!1),c=c.next,f+=1;d.allBuffers=g;doWrite(a,b,!0,b.length,d,"",e.finish);b.pendingcb++;b.lastBufferedRequest=null;e.next?(b.corkedRequestsFree=e.next,e.next=null):b.corkedRequestsFree=new CorkedRequest(b)}else{for(;c&&(d=c.chunk,doWrite(a,b,!1,b.objectMode?1:d.length,d,c.encoding,c.callback),c=c.next,
!b.writing););null===c&&(b.lastBufferedRequest=null)}b.bufferedRequestCount=0;b.bufferedRequest=c;b.bufferProcessing=!1}Writable.prototype._write=function(a,b,c){c(Error("_write() is not implemented"))};Writable.prototype._writev=null;Writable.prototype.end=function(a,b,c){var d=this._writableState;"function"===typeof a?(c=a,b=a=null):"function"===typeof b&&(c=b,b=null);null!==a&&void 0!==a&&this.write(a,b);d.corked&&(d.corked=1,this.uncork());d.ending||d.finished||endWritable(this,d,c)};
function needFinish(a){return a.ending&&0===a.length&&null===a.bufferedRequest&&!a.finished&&!a.writing}function callFinal(a,b){a._final(function(c){b.pendingcb--;c&&a.emit("error",c);b.prefinished=!0;a.emit("prefinish");finishMaybe(a,b)})}function prefinish(a,b){b.prefinished||b.finalCalled||("function"===typeof a._final?(b.pendingcb++,b.finalCalled=!0,processNextTick(callFinal,a,b)):(b.prefinished=!0,a.emit("prefinish")))}
function finishMaybe(a,b){var c=needFinish(b);c&&(prefinish(a,b),0===b.pendingcb&&(b.finished=!0,a.emit("finish")));return c}function endWritable(a,b,c){b.ending=!0;finishMaybe(a,b);if(c)if(b.finished)processNextTick(c);else a.once("finish",c);b.ended=!0;a.writable=!1}function onCorkedFinish(a,b,c){var d=a.entry;for(a.entry=null;d;){var e=d.callback;b.pendingcb--;e(c);d=d.next}b.corkedRequestsFree?b.corkedRequestsFree.next=a:b.corkedRequestsFree=a}
Object.defineProperty(Writable.prototype,"destroyed",{get:function(){return void 0===this._writableState?!1:this._writableState.destroyed},set:function(a){this._writableState&&(this._writableState.destroyed=a)}});Writable.prototype.destroy=destroyImpl.destroy;Writable.prototype._undestroy=destroyImpl.undestroy;Writable.prototype._destroy=function(a,b){this.end();b(a)};
