var processNextTick=require("process-nextick-args");module.exports=Readable;var isArray=require("isarray"),Duplex;Readable.ReadableState=ReadableState;var EE=require("events").EventEmitter,EElistenerCount=function(a,b){return a.listeners(b).length},Stream=require("./internal/streams/stream"),Buffer=require("safe-buffer").Buffer;function _uint8ArrayToBuffer(a){return Buffer.from(a)}function _isUint8Array(a){return"[object Uint8Array]"===Object.prototype.toString.call(a)||Buffer.isBuffer(a)}
var util=require("core-util-is");util.inherits=require("inherits");var debugUtil=require("util"),debug=void 0,debug=debugUtil&&debugUtil.debuglog?debugUtil.debuglog("stream"):function(){},BufferList=require("./internal/streams/BufferList"),destroyImpl=require("./internal/streams/destroy"),StringDecoder;util.inherits(Readable,Stream);var kProxyEvents=["error","close","destroy","pause","resume"];
function prependListener(a,b,c){if("function"===typeof a.prependListener)return a.prependListener(b,c);if(a._events&&a._events[b])isArray(a._events[b])?a._events[b].unshift(c):a._events[b]=[c,a._events[b]];else a.on(b,c)}
function ReadableState(a,b){Duplex=Duplex||require("./_stream_duplex");a=a||{};this.objectMode=!!a.objectMode;b instanceof Duplex&&(this.objectMode=this.objectMode||!!a.readableObjectMode);b=a.highWaterMark;var c=this.objectMode?16:16384;this.highWaterMark=b||0===b?b:c;this.highWaterMark=Math.floor(this.highWaterMark);this.buffer=new BufferList;this.length=0;this.pipes=null;this.pipesCount=0;this.flowing=null;this.reading=this.endEmitted=this.ended=!1;this.sync=!0;this.destroyed=this.resumeScheduled=
this.readableListening=this.emittedReadable=this.needReadable=!1;this.defaultEncoding=a.defaultEncoding||"utf8";this.awaitDrain=0;this.readingMore=!1;this.encoding=this.decoder=null;a.encoding&&(StringDecoder||(StringDecoder=require("string_decoder/").StringDecoder),this.decoder=new StringDecoder(a.encoding),this.encoding=a.encoding)}
function Readable(a){Duplex=Duplex||require("./_stream_duplex");if(!(this instanceof Readable))return new Readable(a);this._readableState=new ReadableState(a,this);this.readable=!0;a&&("function"===typeof a.read&&(this._read=a.read),"function"===typeof a.destroy&&(this._destroy=a.destroy));Stream.call(this)}
Object.defineProperty(Readable.prototype,"destroyed",{get:function(){return void 0===this._readableState?!1:this._readableState.destroyed},set:function(a){this._readableState&&(this._readableState.destroyed=a)}});Readable.prototype.destroy=destroyImpl.destroy;Readable.prototype._undestroy=destroyImpl.undestroy;Readable.prototype._destroy=function(a,b){this.push(null);b(a)};
Readable.prototype.push=function(a,b){var c=this._readableState;if(c.objectMode)var d=!0;else"string"===typeof a&&(b=b||c.defaultEncoding,b!==c.encoding&&(a=Buffer.from(a,b),b=""),d=!0);return readableAddChunk(this,a,b,!1,d)};Readable.prototype.unshift=function(a){return readableAddChunk(this,a,null,!0,!1)};
function readableAddChunk(a,b,c,d,f){var e=a._readableState;if(null===b)e.reading=!1,onEofChunk(a,e);else{var g;f||(g=chunkInvalid(e,b));g?a.emit("error",g):e.objectMode||b&&0<b.length?("string"===typeof b||Object.getPrototypeOf(b)===Buffer.prototype||e.objectMode||(b=_uint8ArrayToBuffer(b)),d?e.endEmitted?a.emit("error",Error("stream.unshift() after end event")):addChunk(a,e,b,!0):e.ended?a.emit("error",Error("stream.push() after EOF")):(e.reading=!1,e.decoder&&!c?(b=e.decoder.write(b),e.objectMode||
0!==b.length?addChunk(a,e,b,!1):maybeReadMore(a,e)):addChunk(a,e,b,!1))):d||(e.reading=!1)}return needMoreData(e)}function addChunk(a,b,c,d){b.flowing&&0===b.length&&!b.sync?(a.emit("data",c),a.read(0)):(b.length+=b.objectMode?1:c.length,d?b.buffer.unshift(c):b.buffer.push(c),b.needReadable&&emitReadable(a));maybeReadMore(a,b)}function chunkInvalid(a,b){var c;_isUint8Array(b)||"string"===typeof b||void 0===b||a.objectMode||(c=new TypeError("Invalid non-string/buffer chunk"));return c}
function needMoreData(a){return!a.ended&&(a.needReadable||a.length<a.highWaterMark||0===a.length)}Readable.prototype.isPaused=function(){return!1===this._readableState.flowing};Readable.prototype.setEncoding=function(a){StringDecoder||(StringDecoder=require("string_decoder/").StringDecoder);this._readableState.decoder=new StringDecoder(a);this._readableState.encoding=a;return this};var MAX_HWM=8388608;
function computeNewHighWaterMark(a){a>=MAX_HWM?a=MAX_HWM:(a--,a|=a>>>1,a|=a>>>2,a|=a>>>4,a|=a>>>8,a|=a>>>16,a++);return a}function howMuchToRead(a,b){if(0>=a||0===b.length&&b.ended)return 0;if(b.objectMode)return 1;if(a!==a)return b.flowing&&b.length?b.buffer.head.data.length:b.length;a>b.highWaterMark&&(b.highWaterMark=computeNewHighWaterMark(a));return a<=b.length?a:b.ended?b.length:(b.needReadable=!0,0)}
Readable.prototype.read=function(a){debug("read",a);a=parseInt(a,10);var b=this._readableState,c=a;0!==a&&(b.emittedReadable=!1);if(0===a&&b.needReadable&&(b.length>=b.highWaterMark||b.ended))return debug("read: emitReadable",b.length,b.ended),0===b.length&&b.ended?endReadable(this):emitReadable(this),null;a=howMuchToRead(a,b);if(0===a&&b.ended)return 0===b.length&&endReadable(this),null;var d=b.needReadable;debug("need readable",d);if(0===b.length||b.length-a<b.highWaterMark)d=!0,debug("length less than watermark",
d);b.ended||b.reading?debug("reading or ended",!1):d&&(debug("do read"),b.reading=!0,b.sync=!0,0===b.length&&(b.needReadable=!0),this._read(b.highWaterMark),b.sync=!1,b.reading||(a=howMuchToRead(c,b)));d=0<a?fromList(a,b):null;null===d?(b.needReadable=!0,a=0):b.length-=a;0===b.length&&(b.ended||(b.needReadable=!0),c!==a&&b.ended&&endReadable(this));null!==d&&this.emit("data",d);return d};
function onEofChunk(a,b){if(!b.ended){if(b.decoder){var c=b.decoder.end();c&&c.length&&(b.buffer.push(c),b.length+=b.objectMode?1:c.length)}b.ended=!0;emitReadable(a)}}function emitReadable(a){var b=a._readableState;b.needReadable=!1;b.emittedReadable||(debug("emitReadable",b.flowing),b.emittedReadable=!0,b.sync?processNextTick(emitReadable_,a):emitReadable_(a))}function emitReadable_(a){debug("emit readable");a.emit("readable");flow(a)}
function maybeReadMore(a,b){b.readingMore||(b.readingMore=!0,processNextTick(maybeReadMore_,a,b))}function maybeReadMore_(a,b){for(var c=b.length;!b.reading&&!b.flowing&&!b.ended&&b.length<b.highWaterMark&&(debug("maybeReadMore read 0"),a.read(0),c!==b.length);)c=b.length;b.readingMore=!1}Readable.prototype._read=function(a){this.emit("error",Error("_read() is not implemented"))};
Readable.prototype.pipe=function(a,b){function c(b,l){debug("onunpipe");b===k&&l&&!1===l.hasUnpiped&&(l.hasUnpiped=!0,debug("cleanup"),a.removeListener("close",g),a.removeListener("finish",n),a.removeListener("drain",p),a.removeListener("error",e),a.removeListener("unpipe",c),k.removeListener("end",d),k.removeListener("end",m),k.removeListener("data",f),q=!0,!h.awaitDrain||a._writableState&&!a._writableState.needDrain||p())}function d(){debug("onend");a.end()}function f(b){debug("ondata");l=!1;!1!==
a.write(b)||l||((1===h.pipesCount&&h.pipes===a||1<h.pipesCount&&-1!==indexOf(h.pipes,a))&&!q&&(debug("false write response, pause",k._readableState.awaitDrain),k._readableState.awaitDrain++,l=!0),k.pause())}function e(b){debug("onerror",b);m();a.removeListener("error",e);0===EElistenerCount(a,"error")&&a.emit("error",b)}function g(){a.removeListener("finish",n);m()}function n(){debug("onfinish");a.removeListener("close",g);m()}function m(){debug("unpipe");k.unpipe(a)}var k=this,h=this._readableState;
switch(h.pipesCount){case 0:h.pipes=a;break;case 1:h.pipes=[h.pipes,a];break;default:h.pipes.push(a)}h.pipesCount+=1;debug("pipe count=%d opts=%j",h.pipesCount,b);b=b&&!1===b.end||a===process.stdout||a===process.stderr?m:d;if(h.endEmitted)processNextTick(b);else k.once("end",b);a.on("unpipe",c);var p=pipeOnDrain(k);a.on("drain",p);var q=!1,l=!1;k.on("data",f);prependListener(a,"error",e);a.once("close",g);a.once("finish",n);a.emit("pipe",k);h.flowing||(debug("pipe resume"),k.resume());return a};
function pipeOnDrain(a){return function(){var b=a._readableState;debug("pipeOnDrain",b.awaitDrain);b.awaitDrain&&b.awaitDrain--;0===b.awaitDrain&&EElistenerCount(a,"data")&&(b.flowing=!0,flow(a))}}
Readable.prototype.unpipe=function(a){var b=this._readableState,c={hasUnpiped:!1};if(0===b.pipesCount)return this;if(1===b.pipesCount){if(a&&a!==b.pipes)return this;a||(a=b.pipes);b.pipes=null;b.pipesCount=0;b.flowing=!1;a&&a.emit("unpipe",this,c);return this}if(!a){a=b.pipes;var d=b.pipesCount;b.pipes=null;b.pipesCount=0;b.flowing=!1;for(b=0;b<d;b++)a[b].emit("unpipe",this,c);return this}d=indexOf(b.pipes,a);if(-1===d)return this;b.pipes.splice(d,1);--b.pipesCount;1===b.pipesCount&&(b.pipes=b.pipes[0]);
a.emit("unpipe",this,c);return this};Readable.prototype.on=function(a,b){b=Stream.prototype.on.call(this,a,b);"data"===a?!1!==this._readableState.flowing&&this.resume():"readable"===a&&(a=this._readableState,a.endEmitted||a.readableListening||(a.readableListening=a.needReadable=!0,a.emittedReadable=!1,a.reading?a.length&&emitReadable(this):processNextTick(nReadingNextTick,this)));return b};Readable.prototype.addListener=Readable.prototype.on;
function nReadingNextTick(a){debug("readable nexttick read 0");a.read(0)}Readable.prototype.resume=function(){var a=this._readableState;a.flowing||(debug("resume"),a.flowing=!0,resume(this,a));return this};function resume(a,b){b.resumeScheduled||(b.resumeScheduled=!0,processNextTick(resume_,a,b))}function resume_(a,b){b.reading||(debug("resume read 0"),a.read(0));b.resumeScheduled=!1;b.awaitDrain=0;a.emit("resume");flow(a);b.flowing&&!b.reading&&a.read(0)}
Readable.prototype.pause=function(){debug("call pause flowing=%j",this._readableState.flowing);!1!==this._readableState.flowing&&(debug("pause"),this._readableState.flowing=!1,this.emit("pause"));return this};function flow(a){var b=a._readableState;for(debug("flow",b.flowing);b.flowing&&null!==a.read(););}
Readable.prototype.wrap=function(a){var b=this._readableState,c=!1,d=this;a.on("end",function(){debug("wrapped end");if(b.decoder&&!b.ended){var a=b.decoder.end();a&&a.length&&d.push(a)}d.push(null)});a.on("data",function(e){debug("wrapped data");b.decoder&&(e=b.decoder.write(e));b.objectMode&&(null===e||void 0===e)||!(b.objectMode||e&&e.length)||d.push(e)||(c=!0,a.pause())});for(var f in a)void 0===this[f]&&"function"===typeof a[f]&&(this[f]=function(b){return function(){return a[b].apply(a,arguments)}}(f));
for(f=0;f<kProxyEvents.length;f++)a.on(kProxyEvents[f],d.emit.bind(d,kProxyEvents[f]));d._read=function(b){debug("wrapped _read",b);c&&(c=!1,a.resume())};return d};Readable._fromList=fromList;function fromList(a,b){if(0===b.length)return null;b.objectMode?a=b.buffer.shift():!a||a>=b.length?(a=b.decoder?b.buffer.join(""):1===b.buffer.length?b.buffer.head.data:b.buffer.concat(b.length),b.buffer.clear()):a=fromListPartial(a,b.buffer,b.decoder);return a}
function fromListPartial(a,b,c){a<b.head.data.length?(c=b.head.data.slice(0,a),b.head.data=b.head.data.slice(a)):c=a===b.head.data.length?b.shift():c?copyFromBufferString(a,b):copyFromBuffer(a,b);return c}function copyFromBufferString(a,b){var c=b.head,d=1,f=c.data;for(a-=f.length;c=c.next;){var e=c.data,g=a>e.length?e.length:a,f=g===e.length?f+e:f+e.slice(0,a);a-=g;if(0===a){g===e.length?(++d,b.head=c.next?c.next:b.tail=null):(b.head=c,c.data=e.slice(g));break}++d}b.length-=d;return f}
function copyFromBuffer(a,b){var c=Buffer.allocUnsafe(a),d=b.head,f=1;d.data.copy(c);for(a-=d.data.length;d=d.next;){var e=d.data,g=a>e.length?e.length:a;e.copy(c,c.length-a,0,g);a-=g;if(0===a){g===e.length?(++f,b.head=d.next?d.next:b.tail=null):(b.head=d,d.data=e.slice(g));break}++f}b.length-=f;return c}function endReadable(a){var b=a._readableState;if(0<b.length)throw Error('"endReadable()" called on non-empty stream');b.endEmitted||(b.ended=!0,processNextTick(endReadableNT,b,a))}
function endReadableNT(a,b){a.endEmitted||0!==a.length||(a.endEmitted=!0,b.readable=!1,b.emit("end"))}function forEach(a,b){for(var c=0,d=a.length;c<d;c++)b(a[c],c)}function indexOf(a,b){for(var c=0,d=a.length;c<d;c++)if(a[c]===b)return c;return-1};
