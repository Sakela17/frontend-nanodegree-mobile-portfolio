module.exports=Transform;var Duplex=require("./_stream_duplex"),util=require("core-util-is");util.inherits=require("inherits");util.inherits(Transform,Duplex);function TransformState(a){this.afterTransform=function(b,c){return afterTransform(a,b,c)};this.transforming=this.needTransform=!1;this.writeencoding=this.writechunk=this.writecb=null}
function afterTransform(a,b,c){var d=a._transformState;d.transforming=!1;var e=d.writecb;if(!e)return a.emit("error",Error("write callback called multiple times"));d.writechunk=null;d.writecb=null;null!==c&&void 0!==c&&a.push(c);e(b);b=a._readableState;b.reading=!1;(b.needReadable||b.length<b.highWaterMark)&&a._read(b.highWaterMark)}
function Transform(a){if(!(this instanceof Transform))return new Transform(a);Duplex.call(this,a);this._transformState=new TransformState(this);var b=this;this._readableState.needReadable=!0;this._readableState.sync=!1;a&&("function"===typeof a.transform&&(this._transform=a.transform),"function"===typeof a.flush&&(this._flush=a.flush));this.once("prefinish",function(){"function"===typeof this._flush?this._flush(function(a,d){done(b,a,d)}):done(b)})}
Transform.prototype.push=function(a,b){this._transformState.needTransform=!1;return Duplex.prototype.push.call(this,a,b)};Transform.prototype._transform=function(a,b,c){throw Error("_transform() is not implemented");};Transform.prototype._write=function(a,b,c){var d=this._transformState;d.writecb=c;d.writechunk=a;d.writeencoding=b;d.transforming||(a=this._readableState,(d.needTransform||a.needReadable||a.length<a.highWaterMark)&&this._read(a.highWaterMark))};
Transform.prototype._read=function(a){a=this._transformState;null!==a.writechunk&&a.writecb&&!a.transforming?(a.transforming=!0,this._transform(a.writechunk,a.writeencoding,a.afterTransform)):a.needTransform=!0};Transform.prototype._destroy=function(a,b){var c=this;Duplex.prototype._destroy.call(this,a,function(a){b(a);c.emit("close")})};
function done(a,b,c){if(b)return a.emit("error",b);null!==c&&void 0!==c&&a.push(c);b=a._transformState;if(a._writableState.length)throw Error("Calling transform done when ws.length != 0");if(b.transforming)throw Error("Calling transform done when still transforming");return a.push(null)};
