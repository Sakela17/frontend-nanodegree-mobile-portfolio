module.exports=globSync;globSync.GlobSync=GlobSync;var fs=require("fs"),minimatch=require("minimatch"),Minimatch=minimatch.Minimatch,Glob=require("./glob.js").Glob,util=require("util"),path=require("path"),assert=require("assert"),common=require("./common.js"),alphasort=common.alphasort,alphasorti=common.alphasorti,isAbsolute=common.isAbsolute,setopts=common.setopts,ownProp=common.ownProp,childrenIgnored=common.childrenIgnored;
function globSync(a,b){if("function"===typeof b||3===arguments.length)throw new TypeError("callback provided to sync glob\nSee: https://github.com/isaacs/node-glob/issues/167");return(new GlobSync(a,b)).found}
function GlobSync(a,b){if(!a)throw Error("must provide pattern");if("function"===typeof b||3===arguments.length)throw new TypeError("callback provided to sync glob\nSee: https://github.com/isaacs/node-glob/issues/167");if(!(this instanceof GlobSync))return new GlobSync(a,b);setopts(this,a,b);if(this.noprocess)return this;var c=this.minimatch.set.length;this.matches=Array(c);for(var d=0;d<c;d++)this._process(this.minimatch.set[d],d,!1);this._finish()}
GlobSync.prototype._finish=function(){assert(this instanceof GlobSync);if(this.realpath){var a=this;this.matches.forEach(function(b,c){c=a.matches[c]=Object.create(null);for(var d in b)try{d=a._makeAbs(d);var e=fs.realpathSync(d,this.realpathCache);c[e]=!0}catch(f){if("stat"===f.syscall)c[a._makeAbs(d)]=!0;else throw f;}})}common.finish(this)};
GlobSync.prototype._process=function(a,b,c){assert(this instanceof GlobSync);for(var d=0;"string"===typeof a[d];)d++;switch(d){case a.length:this._processSimple(a.join("/"),b);return;case 0:var e=null;break;default:e=a.slice(0,d).join("/")}d=a.slice(d);if(null===e)a=".";else{if(isAbsolute(e)||isAbsolute(a.join("/")))e&&isAbsolute(e)||(e="/"+e);a=e}var f=this._makeAbs(a);childrenIgnored(this,a)||(d[0]===minimatch.GLOBSTAR?this._processGlobStar(e,a,f,d,b,c):this._processReaddir(e,a,f,d,b,c))};
GlobSync.prototype._processReaddir=function(a,b,c,d,e,f){if(c=this._readdir(c,f)){var h=d[0],k=!!this.minimatch.negate;b=h._glob;for(var m=this.dot||"."===b.charAt(0),l=[],g=0;g<c.length;g++)b=c[g],("."!==b.charAt(0)||m)&&(k&&!a?!b.match(h):b.match(h))&&l.push(b);c=l.length;if(0!==c)if(1!==d.length||this.mark||this.stat)for(d.shift(),g=0;g<c;g++)b=l[g],this._process((a?[a,b]:[b]).concat(d),e,f);else for(this.matches[e]||(this.matches[e]=Object.create(null)),g=0;g<c;g++)b=l[g],a&&(b="/"!==a.slice(-1)?
a+"/"+b:a+b),"/"!==b.charAt(0)||this.nomount||(b=path.join(this.root,b)),this.matches[e][b]=!0}};GlobSync.prototype._emitMatch=function(a,b){this._makeAbs(b);this.mark&&(b=this._mark(b));if(!this.matches[a][b]){if(this.nodir){var c=this.cache[this._makeAbs(b)];if("DIR"===c||Array.isArray(c))return}this.matches[a][b]=!0;this.stat&&this._stat(b)}};
GlobSync.prototype._readdirInGlobStar=function(a){if(this.follow)return this._readdir(a,!1);var b;try{var c=fs.lstatSync(a)}catch(e){return null}var d=c.isSymbolicLink();(this.symlinks[a]=d)||c.isDirectory()?b=this._readdir(a,!1):this.cache[a]="FILE";return b};
GlobSync.prototype._readdir=function(a,b){if(b&&!ownProp(this.symlinks,a))return this._readdirInGlobStar(a);if(ownProp(this.cache,a)){b=this.cache[a];if(!b||"FILE"===b)return null;if(Array.isArray(b))return b}try{return this._readdirEntries(a,fs.readdirSync(a))}catch(c){return this._readdirError(a,c),null}};GlobSync.prototype._readdirEntries=function(a,b){if(!this.mark&&!this.stat)for(var c=0;c<b.length;c++){var d=b[c],d="/"===a?a+d:a+"/"+d;this.cache[d]=!0}return this.cache[a]=b};
GlobSync.prototype._readdirError=function(a,b){switch(b.code){case "ENOTDIR":this.cache[this._makeAbs(a)]="FILE";break;case "ENOENT":case "ELOOP":case "ENAMETOOLONG":case "UNKNOWN":this.cache[this._makeAbs(a)]=!1;break;default:this.cache[this._makeAbs(a)]=!1;if(this.strict)throw b;this.silent||console.error("glob error",b)}};
GlobSync.prototype._processGlobStar=function(a,b,c,d,e,f){if(b=this._readdir(c,f)){var h=d.slice(1);a=a?[a]:[];var k=a.concat(h);this._process(k,e,!1);k=b.length;if(!this.symlinks[c]||!f)for(c=0;c<k;c++)if("."!==b[c].charAt(0)||this.dot)f=a.concat(b[c],h),this._process(f,e,!0),f=a.concat(b[c],d),this._process(f,e,!0)}};
GlobSync.prototype._processSimple=function(a,b){var c=this._stat(a);this.matches[b]||(this.matches[b]=Object.create(null));c&&(a&&isAbsolute(a)&&!this.nomount&&(c=/[\/\\]$/.test(a),"/"===a.charAt(0)?a=path.join(this.root,a):(a=path.resolve(this.root,a),c&&(a+="/"))),"win32"===process.platform&&(a=a.replace(/\\/g,"/")),this.matches[b][a]=!0)};
GlobSync.prototype._stat=function(a){var b=this._makeAbs(a),c="/"===a.slice(-1);if(a.length>this.maxLength)return!1;if(!this.stat&&ownProp(this.cache,b)){a=this.cache[b];Array.isArray(a)&&(a="DIR");if(!c||"DIR"===a)return a;if(c&&"FILE"===a)return!1}a=this.statCache[b];if(!a){try{var d=fs.lstatSync(b)}catch(e){return!1}if(d.isSymbolicLink())try{a=fs.statSync(b)}catch(e){a=d}else a=d}this.statCache[b]=a;a=a.isDirectory()?"DIR":"FILE";this.cache[b]=this.cache[b]||a;return c&&"DIR"!==a?!1:a};
GlobSync.prototype._mark=function(a){return common.mark(this,a)};GlobSync.prototype._makeAbs=function(a){return common.makeAbs(this,a)};
