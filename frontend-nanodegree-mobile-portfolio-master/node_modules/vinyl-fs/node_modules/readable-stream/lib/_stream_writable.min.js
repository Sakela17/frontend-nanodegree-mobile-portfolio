module.exports=Writable;var Buffer=require("buffer").Buffer;Writable.WritableState=WritableState;var util=require("core-util-is");util.inherits=require("inherits");var Stream=require("stream");util.inherits(Writable,Stream);function WriteReq(c,a,b){this.chunk=c;this.encoding=a;this.callback=b}
function WritableState(c,a){c=c||{};var b=c.highWaterMark;this.highWaterMark=b||0===b?b:16384;this.objectMode=!!c.objectMode;this.highWaterMark=~~this.highWaterMark;this.finished=this.ended=this.ending=this.needDrain=!1;this.decodeStrings=!1!==c.decodeStrings;this.defaultEncoding=c.defaultEncoding||"utf8";this.length=0;this.writing=!1;this.sync=!0;this.bufferProcessing=!1;this.onwrite=function(b){onwrite(a,b)};this.writecb=null;this.writelen=0;this.buffer=[];this.errorEmitted=!1}
function Writable(c){var a=require("./_stream_duplex");if(!(this instanceof Writable||this instanceof a))return new Writable(c);this._writableState=new WritableState(c,this);this.writable=!0;Stream.call(this)}Writable.prototype.pipe=function(){this.emit("error",Error("Cannot pipe. Not readable."))};function writeAfterEnd(c,a,b){var d=Error("write after end");c.emit("error",d);process.nextTick(function(){b(d)})}
function validChunk(c,a,b,d){var e=!0;if(!Buffer.isBuffer(b)&&"string"!==typeof b&&null!==b&&void 0!==b&&!a.objectMode){var f=new TypeError("Invalid non-string/buffer chunk");c.emit("error",f);process.nextTick(function(){d(f)});e=!1}return e}
Writable.prototype.write=function(c,a,b){var d=this._writableState,e=!1;"function"===typeof a&&(b=a,a=null);Buffer.isBuffer(c)?a="buffer":a||(a=d.defaultEncoding);"function"!==typeof b&&(b=function(){});d.ended?writeAfterEnd(this,d,b):validChunk(this,d,c,b)&&(e=writeOrBuffer(this,d,c,a,b));return e};function decodeChunk(c,a,b){c.objectMode||!1===c.decodeStrings||"string"!==typeof a||(a=new Buffer(a,b));return a}
function writeOrBuffer(c,a,b,d,e){b=decodeChunk(a,b,d);Buffer.isBuffer(b)&&(d="buffer");var f=a.objectMode?1:b.length;a.length+=f;var g=a.length<a.highWaterMark;g||(a.needDrain=!0);a.writing?a.buffer.push(new WriteReq(b,d,e)):doWrite(c,a,f,b,d,e);return g}function doWrite(c,a,b,d,e,f){a.writelen=b;a.writecb=f;a.writing=!0;a.sync=!0;c._write(d,e,a.onwrite);a.sync=!1}function onwriteError(c,a,b,d,e){b?process.nextTick(function(){e(d)}):e(d);c._writableState.errorEmitted=!0;c.emit("error",d)}
function onwriteStateUpdate(c){c.writing=!1;c.writecb=null;c.length-=c.writelen;c.writelen=0}function onwrite(c,a){var b=c._writableState,d=b.sync,e=b.writecb;onwriteStateUpdate(b);if(a)onwriteError(c,b,d,a,e);else{var f=needFinish(c,b);f||b.bufferProcessing||!b.buffer.length||clearBuffer(c,b);d?process.nextTick(function(){afterWrite(c,b,f,e)}):afterWrite(c,b,f,e)}}function afterWrite(c,a,b,d){b||onwriteDrain(c,a);d();b&&finishMaybe(c,a)}
function onwriteDrain(c,a){0===a.length&&a.needDrain&&(a.needDrain=!1,c.emit("drain"))}function clearBuffer(c,a){a.bufferProcessing=!0;for(var b=0;b<a.buffer.length;b++){var d=a.buffer[b],e=d.chunk;doWrite(c,a,a.objectMode?1:e.length,e,d.encoding,d.callback);if(a.writing){b++;break}}a.bufferProcessing=!1;b<a.buffer.length?a.buffer=a.buffer.slice(b):a.buffer.length=0}Writable.prototype._write=function(c,a,b){b(Error("not implemented"))};
Writable.prototype.end=function(c,a,b){var d=this._writableState;"function"===typeof c?(b=c,a=c=null):"function"===typeof a&&(b=a,a=null);"undefined"!==typeof c&&null!==c&&this.write(c,a);d.ending||d.finished||endWritable(this,d,b)};function needFinish(c,a){return a.ending&&0===a.length&&!a.finished&&!a.writing}function finishMaybe(c,a){var b=needFinish(c,a);b&&(a.finished=!0,c.emit("finish"));return b}
function endWritable(c,a,b){a.ending=!0;finishMaybe(c,a);if(b)if(a.finished)process.nextTick(b);else c.once("finish",b);a.ended=!0};
