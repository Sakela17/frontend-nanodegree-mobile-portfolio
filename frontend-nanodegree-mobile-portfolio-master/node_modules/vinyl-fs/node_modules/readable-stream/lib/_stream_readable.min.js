module.exports=Readable;var isArray=require("isarray"),Buffer=require("buffer").Buffer;Readable.ReadableState=ReadableState;var EE=require("events").EventEmitter;EE.listenerCount||(EE.listenerCount=function(b,a){return b.listeners(a).length});var Stream=require("stream"),util=require("core-util-is");util.inherits=require("inherits");var StringDecoder;util.inherits(Readable,Stream);
function ReadableState(b,a){b=b||{};this.highWaterMark=(a=b.highWaterMark)||0===a?a:16384;this.highWaterMark=~~this.highWaterMark;this.buffer=[];this.length=0;this.pipes=null;this.pipesCount=0;this.calledRead=this.reading=this.endEmitted=this.ended=this.flowing=!1;this.sync=!0;this.readableListening=this.emittedReadable=this.needReadable=!1;this.objectMode=!!b.objectMode;this.defaultEncoding=b.defaultEncoding||"utf8";this.ranOut=!1;this.awaitDrain=0;this.readingMore=!1;this.encoding=this.decoder=
null;b.encoding&&(StringDecoder||(StringDecoder=require("string_decoder/").StringDecoder),this.decoder=new StringDecoder(b.encoding),this.encoding=b.encoding)}function Readable(b){if(!(this instanceof Readable))return new Readable(b);this._readableState=new ReadableState(b,this);this.readable=!0;Stream.call(this)}
Readable.prototype.push=function(b,a){var c=this._readableState;"string"!==typeof b||c.objectMode||(a=a||c.defaultEncoding,a!==c.encoding&&(b=new Buffer(b,a),a=""));return readableAddChunk(this,c,b,a,!1)};Readable.prototype.unshift=function(b){return readableAddChunk(this,this._readableState,b,"",!0)};
function readableAddChunk(b,a,c,d,f){var e=chunkInvalid(a,c);e?b.emit("error",e):null===c||void 0===c?(a.reading=!1,a.ended||onEofChunk(b,a)):a.objectMode||c&&0<c.length?a.ended&&!f?(c=Error("stream.push() after EOF"),b.emit("error",c)):a.endEmitted&&f?(c=Error("stream.unshift() after end event"),b.emit("error",c)):(!a.decoder||f||d||(c=a.decoder.write(c)),a.length+=a.objectMode?1:c.length,f?a.buffer.unshift(c):(a.reading=!1,a.buffer.push(c)),a.needReadable&&emitReadable(b),maybeReadMore(b,a)):f||
(a.reading=!1);return needMoreData(a)}function needMoreData(b){return!b.ended&&(b.needReadable||b.length<b.highWaterMark||0===b.length)}Readable.prototype.setEncoding=function(b){StringDecoder||(StringDecoder=require("string_decoder/").StringDecoder);this._readableState.decoder=new StringDecoder(b);this._readableState.encoding=b};var MAX_HWM=8388608;function roundUpToNextPowerOf2(b){if(b>=MAX_HWM)b=MAX_HWM;else{b--;for(var a=1;32>a;a<<=1)b|=b>>a;b++}return b}
function howMuchToRead(b,a){if(0===a.length&&a.ended)return 0;if(a.objectMode)return 0===b?0:1;if(null===b||isNaN(b))return a.flowing&&a.buffer.length?a.buffer[0].length:a.length;if(0>=b)return 0;b>a.highWaterMark&&(a.highWaterMark=roundUpToNextPowerOf2(b));if(b>a.length){if(a.ended)return a.length;a.needReadable=!0;return 0}return b}
Readable.prototype.read=function(b){var a=this._readableState;a.calledRead=!0;var c=b;if("number"!==typeof b||0<b)a.emittedReadable=!1;if(0===b&&a.needReadable&&(a.length>=a.highWaterMark||a.ended))return emitReadable(this),null;b=howMuchToRead(b,a);if(0===b&&a.ended)return c=null,0<a.length&&a.decoder&&(c=fromList(b,a),a.length-=c.length),0===a.length&&endReadable(this),c;var d=a.needReadable;a.length-b<=a.highWaterMark&&(d=!0);if(a.ended||a.reading)d=!1;d&&(a.reading=!0,a.sync=!0,0===a.length&&
(a.needReadable=!0),this._read(a.highWaterMark),a.sync=!1);d&&!a.reading&&(b=howMuchToRead(c,a));c=0<b?fromList(b,a):null;null===c&&(a.needReadable=!0,b=0);a.length-=b;0!==a.length||a.ended||(a.needReadable=!0);a.ended&&!a.endEmitted&&0===a.length&&endReadable(this);return c};function chunkInvalid(b,a){var c=null;Buffer.isBuffer(a)||"string"===typeof a||null===a||void 0===a||b.objectMode||(c=new TypeError("Invalid non-string/buffer chunk"));return c}
function onEofChunk(b,a){if(a.decoder&&!a.ended){var c=a.decoder.end();c&&c.length&&(a.buffer.push(c),a.length+=a.objectMode?1:c.length)}a.ended=!0;0<a.length?emitReadable(b):endReadable(b)}function emitReadable(b){var a=b._readableState;a.needReadable=!1;a.emittedReadable||(a.emittedReadable=!0,a.sync?process.nextTick(function(){emitReadable_(b)}):emitReadable_(b))}function emitReadable_(b){b.emit("readable")}
function maybeReadMore(b,a){a.readingMore||(a.readingMore=!0,process.nextTick(function(){maybeReadMore_(b,a)}))}function maybeReadMore_(b,a){for(var c=a.length;!a.reading&&!a.flowing&&!a.ended&&a.length<a.highWaterMark&&(b.read(0),c!==a.length);)c=a.length;a.readingMore=!1}Readable.prototype._read=function(b){this.emit("error",Error("not implemented"))};
Readable.prototype.pipe=function(b,a){function c(b){b===g&&f()}function d(){b.end()}function f(){b.removeListener("close",k);b.removeListener("finish",l);b.removeListener("drain",m);b.removeListener("error",e);b.removeListener("unpipe",c);g.removeListener("end",d);g.removeListener("end",f);b._writableState&&!b._writableState.needDrain||m()}function e(a){g.unpipe(b);b.removeListener("error",e);0===EE.listenerCount(b,"error")&&b.emit("error",a)}function k(){b.removeListener("finish",l);g.unpipe(b)}
function l(){b.removeListener("close",k);g.unpipe(b)}var g=this,h=this._readableState;switch(h.pipesCount){case 0:h.pipes=b;break;case 1:h.pipes=[h.pipes,b];break;default:h.pipes.push(b)}h.pipesCount+=1;a=a&&!1===a.end||b===process.stdout||b===process.stderr?f:d;if(h.endEmitted)process.nextTick(a);else g.once("end",a);b.on("unpipe",c);var m=pipeOnDrain(g);b.on("drain",m);if(b._events&&b._events.error)isArray(b._events.error)?b._events.error.unshift(e):b._events.error=[e,b._events.error];else b.on("error",
e);b.once("close",k);b.once("finish",l);b.emit("pipe",g);h.flowing||(this.on("readable",pipeOnReadable),h.flowing=!0,process.nextTick(function(){flow(g)}));return b};function pipeOnDrain(b){return function(){var a=b._readableState;a.awaitDrain--;0===a.awaitDrain&&flow(b)}}
function flow(b){function a(b,a,k){!1===b.write(d)&&c.awaitDrain++}var c=b._readableState,d;for(c.awaitDrain=0;c.pipesCount&&null!==(d=b.read());)if(1===c.pipesCount?a(c.pipes,0,null):forEach(c.pipes,a),b.emit("data",d),0<c.awaitDrain)return;0===c.pipesCount?(c.flowing=!1,0<EE.listenerCount(b,"data")&&emitDataEvents(b)):c.ranOut=!0}function pipeOnReadable(){this._readableState.ranOut&&(this._readableState.ranOut=!1,flow(this))}
Readable.prototype.unpipe=function(b){var a=this._readableState;if(0===a.pipesCount)return this;if(1===a.pipesCount){if(b&&b!==a.pipes)return this;b||(b=a.pipes);a.pipes=null;a.pipesCount=0;this.removeListener("readable",pipeOnReadable);a.flowing=!1;b&&b.emit("unpipe",this);return this}if(!b){b=a.pipes;var c=a.pipesCount;a.pipes=null;a.pipesCount=0;this.removeListener("readable",pipeOnReadable);a.flowing=!1;for(var d=0;d<c;d++)b[d].emit("unpipe",this);return this}d=indexOf(a.pipes,b);if(-1===d)return this;
a.pipes.splice(d,1);--a.pipesCount;1===a.pipesCount&&(a.pipes=a.pipes[0]);b.emit("unpipe",this);return this};Readable.prototype.on=function(b,a){a=Stream.prototype.on.call(this,b,a);"data"!==b||this._readableState.flowing||emitDataEvents(this);"readable"===b&&this.readable&&(b=this._readableState,b.readableListening||(b.readableListening=!0,b.emittedReadable=!1,b.needReadable=!0,b.reading?b.length&&emitReadable(this,b):this.read(0)));return a};Readable.prototype.addListener=Readable.prototype.on;
Readable.prototype.resume=function(){emitDataEvents(this);this.read(0);this.emit("resume")};Readable.prototype.pause=function(){emitDataEvents(this,!0);this.emit("pause")};
function emitDataEvents(b,a){if(b._readableState.flowing)throw Error("Cannot switch to old mode now.");var c=a||!1,d=!1;b.readable=!0;b.pipe=Stream.prototype.pipe;b.on=b.addListener=Stream.prototype.on;b.on("readable",function(){d=!0;for(var a;!c&&null!==(a=b.read());)b.emit("data",a);null===a&&(d=!1,b._readableState.needReadable=!0)});b.pause=function(){c=!0;this.emit("pause")};b.resume=function(){c=!1;d?process.nextTick(function(){b.emit("readable")}):this.read(0);this.emit("resume")};b.emit("readable")}
Readable.prototype.wrap=function(b){var a=this._readableState,c=!1,d=this;b.on("end",function(){if(a.decoder&&!a.ended){var b=a.decoder.end();b&&b.length&&d.push(b)}d.push(null)});b.on("data",function(e){a.decoder&&(e=a.decoder.write(e));a.objectMode&&(null===e||void 0===e)||!(a.objectMode||e&&e.length)||d.push(e)||(c=!0,b.pause())});for(var f in b)"function"===typeof b[f]&&"undefined"===typeof this[f]&&(this[f]=function(a){return function(){return b[a].apply(b,arguments)}}(f));forEach(["error","close",
"destroy","pause","resume"],function(a){b.on(a,d.emit.bind(d,a))});d._read=function(a){c&&(c=!1,b.resume())};return d};Readable._fromList=fromList;
function fromList(b,a){var c=a.buffer;var d=a.length;var f=!!a.decoder;a=!!a.objectMode;if(0===c.length)return null;if(0===d)a=null;else if(a)a=c.shift();else if(!b||b>=d)a=f?c.join(""):Buffer.concat(c,d),c.length=0;else if(b<c[0].length)d=c[0],a=d.slice(0,b),c[0]=d.slice(b);else if(b===c[0].length)a=c.shift();else{a=f?"":new Buffer(b);for(var e=0,k=0,l=c.length;k<l&&e<b;k++){d=c[0];var g=Math.min(b-e,d.length);f?a+=d.slice(0,g):d.copy(a,e,0,g);g<d.length?c[0]=d.slice(g):c.shift();e+=g}}return a}
function endReadable(b){var a=b._readableState;if(0<a.length)throw Error("endReadable called on non-empty stream");!a.endEmitted&&a.calledRead&&(a.ended=!0,process.nextTick(function(){a.endEmitted||0!==a.length||(a.endEmitted=!0,b.readable=!1,b.emit("end"))}))}function forEach(b,a){for(var c=0,d=b.length;c<d;c++)a(b[c],c)}function indexOf(b,a){for(var c=0,d=b.length;c<d;c++)if(b[c]===a)return c;return-1};
