module.exports=Transform;var Duplex=require("./_stream_duplex"),util=require("core-util-is");util.inherits=require("inherits");util.inherits(Transform,Duplex);function TransformState(a,b){this.afterTransform=function(a,c){return afterTransform(b,a,c)};this.transforming=this.needTransform=!1;this.writechunk=this.writecb=null}
function afterTransform(a,b,d){var c=a._transformState;c.transforming=!1;var e=c.writecb;if(!e)return a.emit("error",Error("no writecb in Transform class"));c.writechunk=null;c.writecb=null;null!==d&&void 0!==d&&a.push(d);e&&e(b);b=a._readableState;b.reading=!1;(b.needReadable||b.length<b.highWaterMark)&&a._read(b.highWaterMark)}
function Transform(a){if(!(this instanceof Transform))return new Transform(a);Duplex.call(this,a);this._transformState=new TransformState(a,this);var b=this;this._readableState.needReadable=!0;this._readableState.sync=!1;this.once("finish",function(){"function"===typeof this._flush?this._flush(function(a){done(b,a)}):done(b)})}Transform.prototype.push=function(a,b){this._transformState.needTransform=!1;return Duplex.prototype.push.call(this,a,b)};
Transform.prototype._transform=function(a,b,d){throw Error("not implemented");};Transform.prototype._write=function(a,b,d){var c=this._transformState;c.writecb=d;c.writechunk=a;c.writeencoding=b;c.transforming||(a=this._readableState,(c.needTransform||a.needReadable||a.length<a.highWaterMark)&&this._read(a.highWaterMark))};
Transform.prototype._read=function(a){a=this._transformState;null!==a.writechunk&&a.writecb&&!a.transforming?(a.transforming=!0,this._transform(a.writechunk,a.writeencoding,a.afterTransform)):a.needTransform=!0};function done(a,b){if(b)return a.emit("error",b);b=a._transformState;if(a._writableState.length)throw Error("calling transform done when ws.length != 0");if(b.transforming)throw Error("calling transform done when still transforming");return a.push(null)};
