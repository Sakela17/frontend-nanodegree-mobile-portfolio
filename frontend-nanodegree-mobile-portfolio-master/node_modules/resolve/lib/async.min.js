var core=require("./core"),fs=require("fs"),path=require("path"),caller=require("./caller.js"),nodeModulesPaths=require("./node-modules-paths.js");
module.exports=function(b,y,z){function t(d,c,a){d?e(d):c?e(null,c,a):p(l,function(d,c,a){d?e(d):c?e(null,c,a):(d=Error("Cannot find module '"+b+"' from '"+n+"'"),d.code="MODULE_NOT_FOUND",e(d))})}function k(d,c,a){function g(d,c,a){function b(a,b,e){h=b;if(a)return m(a);if(e&&h&&f.pathFilter&&(a=path.relative(e,q),a=a.slice(0,a.length-d[0].length),a=f.pathFilter(h,c,a)))return g([""].concat(u.slice()),path.resolve(e,a),h);r(q,A)}function A(a,f){if(a)return m(a);if(f)return m(null,q,h);g(d.slice(1),
c,h)}if(0===d.length)return m(null,void 0,a);var q=c+d[0],h=a;h?b(null,h):v(path.dirname(q),b)}var m=a;"function"===typeof c&&(m=c,c=void 0);a=[""].concat(u);g(a,d,c)}function v(d,c){if(""===d||"/"===d||"win32"===process.platform&&/^\w:[/\\]*$/.test(d)||/[/\\]node_modules[/\\]*$/.test(d))return c(null);var a=path.join(d,"package.json");r(a,function(g,b){if(!b)return v(path.dirname(d),c);w(a,function(g,b){g&&c(g);try{var e=JSON.parse(b)}catch(D){}e&&f.packageFilter&&(e=f.packageFilter(e,a));c(null,
e,d)})})}function p(d,c,a){var g=a,b=c;"function"===typeof b&&(g=b,b=f.package);var e=path.join(d,"package.json");r(e,function(a,c){if(a)return g(a);if(!c)return k(path.join(d,"index"),b,g);w(e,function(a,c){if(a)return g(a);try{var b=JSON.parse(c)}catch(h){}f.packageFilter&&(b=f.packageFilter(b,e));if(b.main){if("."===b.main||"./"===b.main)b.main="index";k(path.resolve(d,b.main),b,function(a,c,b){if(a)return g(a);if(c)return g(null,c,b);if(!b)return k(path.join(d,"index"),b,g);a=path.resolve(d,b.main);
p(a,b,function(a,b,c){if(a)return g(a);if(b)return g(null,b,c);k(path.join(d,"index"),c,g)})})}else k(path.join(d,"/index"),b,g)})})}function x(d,c){function a(a,b,e){if(a)return d(a);if(b)return d(null,b,e);x(d,c.slice(1))}if(0===c.length)return d(null,void 0);var g=c[0],e=path.join(g,b);k(e,void 0,function(c,e,f){if(c)return d(c);if(e)return d(null,e,f);p(path.join(g,b),void 0,a)})}function B(b,c,a){x(a,nodeModulesPaths(c,f))}var e=z,f=y||{};"function"===typeof f&&(e=f,f={});if("string"!==typeof b){var C=
new TypeError("Path must be a string.");return process.nextTick(function(){e(C)})}var r=f.isFile||function(b,c){fs.stat(b,function(a,b){return a?"ENOENT"===a.code||"ENOTDIR"===a.code?c(null,!1):c(a):c(null,b.isFile()||b.isFIFO())})},w=f.readFile||fs.readFile,u=f.extensions||[".js"],n=f.basedir||path.dirname(caller());f.paths=f.paths||[];if(/^(?:\.\.?(?:\/|$)|\/|([A-Za-z]:)?[/\\])/.test(b)){var l=path.resolve(n,b);if(".."===b||"/"===b.slice(-1))l+="/";/\/$/.test(b)&&l===n?p(l,f.package,t):k(l,f.package,
t)}else B(b,n,function(d,c,a){if(d)e(d);else if(c)e(null,c,a);else{if(core[b])return e(null,b);d=Error("Cannot find module '"+b+"' from '"+n+"'");d.code="MODULE_NOT_FOUND";e(d)}})};
