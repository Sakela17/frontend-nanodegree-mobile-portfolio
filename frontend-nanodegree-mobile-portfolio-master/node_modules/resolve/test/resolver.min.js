var path=require("path"),test=require("tape"),resolve=require("../");
test("async foo",function(a){a.plan(10);var c=path.join(__dirname,"resolver");resolve("./foo",{basedir:c},function(b,d,e){b&&a.fail(b);a.equal(d,path.join(c,"foo.js"));a.equal(e&&e.name,"resolve")});resolve("./foo.js",{basedir:c},function(b,d,e){b&&a.fail(b);a.equal(d,path.join(c,"foo.js"));a.equal(e&&e.name,"resolve")});resolve("./foo",{basedir:c,"package":{main:"resolver"}},function(b,d,e){b&&a.fail(b);a.equal(d,path.join(c,"foo.js"));a.equal(e&&e.main,"resolver")});resolve("./foo.js",{basedir:c,
"package":{main:"resolver"}},function(b,d,e){b&&a.fail(b);a.equal(d,path.join(c,"foo.js"));a.equal(e.main,"resolver")});resolve("foo",{basedir:c},function(b){a.equal(b.message,"Cannot find module 'foo' from '"+path.resolve(c)+"'");a.equal(b.code,"MODULE_NOT_FOUND")})});
test("bar",function(a){a.plan(6);var c=path.join(__dirname,"resolver");resolve("foo",{basedir:c+"/bar"},function(b,d,e){b&&a.fail(b);a.equal(d,path.join(c,"bar/node_modules/foo/index.js"));a.equal(e,void 0)});resolve("foo",{basedir:c+"/bar"},function(b,d,e){b&&a.fail(b);a.equal(d,path.join(c,"bar/node_modules/foo/index.js"));a.equal(e,void 0)});resolve("foo",{basedir:c+"/bar","package":{main:"bar"}},function(b,d,e){b&&a.fail(b);a.equal(d,path.join(c,"bar/node_modules/foo/index.js"));a.equal(e,void 0)})});
test("baz",function(a){a.plan(4);var c=path.join(__dirname,"resolver");resolve("./baz",{basedir:c},function(b,d,e){b&&a.fail(b);a.equal(d,path.join(c,"baz/quux.js"));a.equal(e.main,"quux.js")});resolve("./baz",{basedir:c,"package":{main:"resolver"}},function(b,d,e){b&&a.fail(b);a.equal(d,path.join(c,"baz/quux.js"));a.equal(e.main,"quux.js")})});
test("biz",function(a){a.plan(24);var c=path.join(__dirname,"resolver/biz/node_modules");resolve("./grux",{basedir:c},function(b,d,e){b&&a.fail(b);a.equal(d,path.join(c,"grux/index.js"));a.equal(e,void 0)});resolve("./grux",{basedir:c,"package":{main:"biz"}},function(b,d,e){b&&a.fail(b);a.equal(d,path.join(c,"grux/index.js"));a.equal(e.main,"biz")});resolve("./garply",{basedir:c},function(b,d,e){b&&a.fail(b);a.equal(d,path.join(c,"garply/lib/index.js"));a.equal(e.main,"./lib")});resolve("./garply",
{basedir:c,"package":{main:"biz"}},function(b,d,e){b&&a.fail(b);a.equal(d,path.join(c,"garply/lib/index.js"));a.equal(e.main,"./lib")});resolve("tiv",{basedir:c+"/grux"},function(b,d,e){b&&a.fail(b);a.equal(d,path.join(c,"tiv/index.js"));a.equal(e,void 0)});resolve("tiv",{basedir:c+"/grux","package":{main:"grux"}},function(b,d,e){b&&a.fail(b);a.equal(d,path.join(c,"tiv/index.js"));a.equal(e,void 0)});resolve("tiv",{basedir:c+"/garply"},function(b,d,e){b&&a.fail(b);a.equal(d,path.join(c,"tiv/index.js"));
a.equal(e,void 0)});resolve("tiv",{basedir:c+"/garply","package":{main:"./lib"}},function(b,d,e){b&&a.fail(b);a.equal(d,path.join(c,"tiv/index.js"));a.equal(e,void 0)});resolve("grux",{basedir:c+"/tiv"},function(b,d,e){b&&a.fail(b);a.equal(d,path.join(c,"grux/index.js"));a.equal(e,void 0)});resolve("grux",{basedir:c+"/tiv","package":{main:"tiv"}},function(b,d,e){b&&a.fail(b);a.equal(d,path.join(c,"grux/index.js"));a.equal(e,void 0)});resolve("garply",{basedir:c+"/tiv"},function(b,d,e){b&&a.fail(b);
a.equal(d,path.join(c,"garply/lib/index.js"));a.equal(e.main,"./lib")});resolve("garply",{basedir:c+"/tiv","package":{main:"tiv"}},function(b,d,e){b&&a.fail(b);a.equal(d,path.join(c,"garply/lib/index.js"));a.equal(e.main,"./lib")})});test("quux",function(a){a.plan(2);var c=path.join(__dirname,"resolver/quux");resolve("./foo",{basedir:c,"package":{main:"quux"}},function(b,d,e){b&&a.fail(b);a.equal(d,path.join(c,"foo/index.js"));a.equal(e.main,"quux")})});
test("normalize",function(a){a.plan(2);var c=path.join(__dirname,"resolver/biz/node_modules/grux");resolve("../grux",{basedir:c},function(b,d,e){b&&a.fail(b);a.equal(d,path.join(c,"index.js"));a.equal(e,void 0)})});
test("cup",function(a){a.plan(4);var c=path.join(__dirname,"resolver");resolve("./cup",{basedir:c,extensions:[".js",".coffee"]},function(b,d){b&&a.fail(b);a.equal(d,path.join(c,"cup.coffee"))});resolve("./cup.coffee",{basedir:c},function(b,d){b&&a.fail(b);a.equal(d,path.join(c,"cup.coffee"))});resolve("./cup",{basedir:c,extensions:[".js"]},function(b,d){a.equal(b.message,"Cannot find module './cup' from '"+path.resolve(c)+"'");a.equal(b.code,"MODULE_NOT_FOUND")})});
test("mug",function(a){a.plan(3);var c=path.join(__dirname,"resolver");resolve("./mug",{basedir:c},function(b,d){b&&a.fail(b);a.equal(d,path.join(c,"mug.js"))});resolve("./mug",{basedir:c,extensions:[".coffee",".js"]},function(b,d){b&&a.fail(b);a.equal(d,path.join(c,"/mug.coffee"))});resolve("./mug",{basedir:c,extensions:[".js",".coffee"]},function(b,d){a.equal(d,path.join(c,"/mug.js"))})});
test("other path",function(a){a.plan(6);var c=path.join(__dirname,"resolver"),b=path.join(c,"bar"),d=path.join(c,"other_path");resolve("root",{basedir:b,paths:[d]},function(b,d){b&&a.fail(b);a.equal(d,path.join(c,"other_path/root.js"))});resolve("lib/other-lib",{basedir:b,paths:[d]},function(b,d){b&&a.fail(b);a.equal(d,path.join(c,"other_path/lib/other-lib.js"))});resolve("root",{basedir:b},function(c,d){a.equal(c.message,"Cannot find module 'root' from '"+path.resolve(b)+"'");a.equal(c.code,"MODULE_NOT_FOUND")});
resolve("zzz",{basedir:b,paths:[d]},function(c,d){a.equal(c.message,"Cannot find module 'zzz' from '"+path.resolve(b)+"'");a.equal(c.code,"MODULE_NOT_FOUND")})});test("incorrect main",function(a){a.plan(1);var c=path.join(__dirname,"resolver"),b=path.join(c,"incorrect_main");resolve("./incorrect_main",{basedir:c},function(c,e,f){c&&a.fail(c);a.equal(e,path.join(b,"index.js"))})});
test("without basedir",function(a){a.plan(1);var c=path.join(__dirname,"resolver/without_basedir");require(path.join(c,"main.js"))(a,function(b,d,e){b?a.fail(b):a.equal(d,path.join(c,"node_modules/mymodule.js"))})});test("#25: node modules with the same name as node stdlib modules",function(a){a.plan(1);var c=path.join(__dirname,"resolver/punycode");resolve("punycode",{basedir:c},function(b,d,e){b&&a.fail(b);a.equal(d,path.join(c,"node_modules/punycode/index.js"))})});
test('#52 - incorrectly resolves module-paths like "./someFolder/" when there is a file of the same name',function(a){a.plan(2);var c=path.join(__dirname,"resolver");resolve("./foo",{basedir:path.join(c,"same_names")},function(b,d,e){b&&a.fail(b);a.equal(d,path.join(c,"same_names/foo.js"))});resolve("./foo/",{basedir:path.join(c,"same_names")},function(b,d,e){b&&a.fail(b);a.equal(d,path.join(c,"same_names/foo/index.js"))})});
test("async: #121 - treating an existing file as a dir when no basedir",function(a){var c=path.basename(__filename);a.test("sanity check",function(b){b.plan(1);resolve("./"+c,function(c,e,f){c&&a.fail(c);b.equal(e,__filename,"sanity check")})});a.test("with a fake directory",function(a){a.plan(4);resolve("./"+c+"/blah",function(b,e,f){a.ok(b,"there is an error");a.notOk(e,"no result");a.equal(b&&b.code,"MODULE_NOT_FOUND","error code matches require.resolve");a.equal(b&&b.message,"Cannot find module './"+
c+"/blah' from '"+__dirname+"'","can not find nonexistent module");a.end()})});a.end()});
